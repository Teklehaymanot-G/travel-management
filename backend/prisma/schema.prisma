generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int         @id @default(autoincrement())
  name        String?
  phone       String      @unique
  password    String
  profileImageUrl String?
  role        Role
  bookings    Booking[]
  comments    Comment[]
  commentLikes CommentLike[]
  travels     Travel[]    @relation("CreatedTravels")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  Ticket Ticket[]

  Payment Payment[]
}

model Travel {
  id          Int         @id @default(autoincrement())
  title       String
  description String
  startDate   DateTime
  endDate     DateTime
  price       Float
  imageUrl    String?
  itinerary   String?
  requirements String?
  status      TravelStatus @default(PLANNED)
  bookings    Booking[]
  documents   TravelDocument[]
  comments    Comment[]
  createdBy   User        @relation("CreatedTravels", fields: [createdById], references: [id])
  createdById Int
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Booking {
  id          Int         @id @default(autoincrement())
  traveler    User        @relation(fields: [travelerId], references: [id])
  travelerId  Int
  travel      Travel      @relation(fields: [travelId], references: [id])
  travelId    Int
  status      BookingStatus @default(PENDING)
  participants Json?      // store participants to generate tickets upon payment approval
  tickets     Ticket[]    
  payment     Payment?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Ticket {
  id          Int         @id @default(autoincrement())
  booking     Booking     @relation(fields: [bookingId], references: [id])
  bookingId   Int
  name        String
  age         Int
  badgeNumber String?     
  qrCodeUrl   String?     @db.LongText
  checkedIn   Boolean     @default(false)
  checkedInBy User?       @relation(fields: [checkedInById], references: [id])
  checkedInById Int?      
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Payment {
  id          Int         @id @default(autoincrement())
  booking     Booking     @relation(fields: [bookingId], references: [id])
  bookingId   Int @unique
  receiptUrl  String      @db.LongText
  transactionNumber String?
  bank        String?
  paymentDate DateTime?
  status      PaymentStatus @default(PENDING)
  approvedBy  User?       @relation(fields: [approvedById], references: [id])
  approvedById Int?
  rejectionMessage String?
  couponCode  String?    // applied coupon code (immutable after approval)
  discountAmount Float?  // numeric discount applied
  originalAmount Float?  // base amount before discount (travel.price * participants count)
  finalAmount   Float?   // originalAmount - discountAmount
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model TravelDocument {
  id          Int         @id @default(autoincrement())
  travel      Travel      @relation(fields: [travelId], references: [id])
  travelId    Int
  title       String
  fileUrl     String
  createdAt   DateTime    @default(now())
}

model Comment {
  id          Int         @id @default(autoincrement())
  content     String
  type        CommentType
  traveler    User        @relation(fields: [travelerId], references: [id])
  travelerId  Int
  travel      Travel      @relation(fields: [travelId], references: [id])
  travelId    Int
  likes       CommentLike[]
  createdAt   DateTime    @default(now())
}

model CommentLike {
  id        Int      @id @default(autoincrement())
  comment   Comment  @relation(fields: [commentId], references: [id])
  commentId Int
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  createdAt DateTime @default(now())

  @@unique([commentId, userId])
  @@index([userId])
}

enum Role {
  TRAVELER
  MANAGER
  SUPERVISOR
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TravelStatus {
  PLANNED
  ONGOING
  COMPLETED
  CANCELLED
}

enum CommentType {
  PRE_TRAVEL
  POST_TRAVEL
}

enum CouponType {
  PERCENT
  FIXED
}

model Coupon {
  id         Int        @id @default(autoincrement())
  code       String     @unique
  description String?
  type       CouponType @default(PERCENT)
  discount   Int        // percent (1-100) or fixed amount in smallest currency unit assumption
  validFrom  DateTime
  validTo    DateTime
  maxUses    Int?
  used       Int        @default(0)
  active     Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Otp {
  id        Int      @id @default(autoincrement())
  phone     String   @db.VarChar(20)
  codeHash  String
  purpose   String   @db.VarChar(16) // e.g., 'register', 'login', 'reset'
  expiresAt DateTime
  attempts  Int      @default(0)
  usedAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone, purpose, expiresAt])
}

enum BankStatus {
  ACTIVE
  INACTIVE
}

model Bank {
  id            Int        @id @default(autoincrement())
  name          String
  logoUrl       String?
  accountName   String
  accountNumber String
  status        BankStatus @default(ACTIVE)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}